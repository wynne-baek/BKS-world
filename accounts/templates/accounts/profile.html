{% extends 'base.html' %}

{% block content %}
<div class="text-center" style="margin-top: 50px; margin-bottom: 50px">
  <h1>{{ person.username }}님의 Profile</h1>
  <div>
    팔로잉 :
    <span id="following-count">
      {{ following|length }}
    </span>
    |  팔로워 :
    <span id="follower-count">
      {{ follower|length }}
    </span>
  </div>
  {% with following=person.following.all follower=person.follower.all %}
  <div>
    {% if request.user != person %}
      <div class="mt-2">
        <form data-person-id="{{ person.pk }}" id="follow-form">
          {% csrf_token %}
          {% if request.user in follower %}
            <button id="followBtn">언팔로우</button>
          {% else %}
            <button id="followBtn">팔로우</button>
          {% endif %}
        </form>
      </div>
    {% endif %}
  </div>
{% endwith %}
</div>

<div style="min-width: 700px; max-width: 1200px; margin-top: 10px; height: 100vh;" class="mx-auto">
<h3 class="text-center">WATCHED LIST</h3>
<div class="swiper mySwiper">
  <div class="swiper-wrapper">
    {% for movie in user.watched_list.all %}
    <div class="swiper-slide">
      <img src="https://themoviedb.org/t/p/w600_and_h900_bestv2{{ movie.poster_path }}"/>
    </div>
    {% endfor %}
  </div>
  <div class="mt-5"><div class="swiper-pagination"></div></div>
</div>

<hr>
<h3 class="text-center my-5">MOVIE REVEIW</h3>
  {% for review in person.review_set.all %}
    <h5><a class="text-decoration-none text-dark" href="{% url 'community:review_detail' review.pk %}">{{ review.title }}</a></h5>
    <p class="text-secondary">{{ review.content }}</p>
    <hr>
  {% endfor %}


</div>
{% endblock %}

<hr>

{% block script %}
<script>
  // swiper
  var swiper = new Swiper(".mySwiper", {
    effect: "coverflow",
    grabCursor: true,
    centeredSlides: true,
    slidesPerView: "auto",
    coverflowEffect: {
      rotate: 50,
      stretch: 0,
      depth: 100,
      modifier: 1,
      slideShadows: false,
    },
    pagination: {
      el: ".swiper-pagination",
    },
  });
  
  // follow
  const formTag = document.querySelector('#follow-form')
  if (formTag) {
    axios.defaults.xsrfCookieName = 'csrftoken'
    axios.defaults.xsrfHeaderName = 'X-CSRFToken'

    formTag.addEventListener('submit', function(event) {
      event.preventDefault()
      const personId = event.target.dataset.personId
      const URL = `http://127.0.0.1:8000/accounts/${personId}/follow/`
      axios.post(URL)
      .then(res => {
        const followerCount = res.data.follower_count
        const followed = res.data.followed
        const followBtn = document.querySelector('#followBtn')
        const followerNum = document.querySelector('#follower-count')
        if (followed === true) {
          followBtn.value = '언팔로우'
        } else {
          followBtn.value = '팔로우'
        }
        followerNum.innerText = followerCount
      })
    })
  }
</script>

<style>
html, body {
  position: relative;
  height: 100%;
    }

.swiper {
  width: 100%;
  padding-top: 50px;
  padding-bottom: 50px;
}

.swiper-slide {
  background-position: center;
  background-size: cover;
  width: 300px;
  height: 400px;
  margin-right: 30px;
}

.swiper-slide img {
  display: block;
  width: 100%;
}
</style>
{% endblock script %}
